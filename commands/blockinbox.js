// ==================== commands/blockinbox.js ====================
import fs from "fs";
import path from "path";
import config, { saveConfig } from "../config.js";

const configPath = path.join(process.cwd(), "data/config.json");

export default {
  name: "blockinbox",
  description: "Bloque ou d√©bloque les messages priv√©s du bot",
  category: "Owner",
  ownerOnly: true, // le handler bloque d√©j√† les non-owners

  run: async (kaya, m, msg, store, args, context) => {
    try {
      // ‚úÖ V√©rification owner centralis√©e via handler
      if (!context.isOwner) {
        return kaya.sendMessage(
          m.chat,
          { text: "üö´ Cette commande est r√©serv√©e au propri√©taire du bot." },
          { quoted: m }
        );
      }

      if (!args[0] || !["on", "off"].includes(args[0].toLowerCase())) {
        return kaya.sendMessage(
          m.chat,
          { text: "‚ùå Utilisation :\n.blockinbox on\n.blockinbox off" },
          { quoted: m }
        );
      }

      const action = args[0].toLowerCase();

      // Initialise global si n√©cessaire
      if (!global.blockInbox) global.blockInbox = new Set();

      if (action === "on") {
        global.blockInbox.add("enabled");
        config.blockInbox = true;
        await kaya.sendMessage(
          m.chat,
          { text: "‚úÖ Le bot ne r√©pondra plus en priv√© aux utilisateurs. Il reste actif dans les groupes." },
          { quoted: m }
        );
      } else {
        global.blockInbox.delete("enabled");
        config.blockInbox = false;
        await kaya.sendMessage(
          m.chat,
          { text: "‚úÖ Le bot peut √† nouveau r√©pondre en priv√© aux utilisateurs." },
          { quoted: m }
        );
      }

      // Sauvegarde config
      if (saveConfig) saveConfig({ blockInbox: config.blockInbox });

    } catch (err) {
      console.error("‚ùå Erreur blockinbox.js :", err);
      return kaya.sendMessage(
        m.chat,
        { text: "‚ùå Une erreur est survenue lors de la modification du mode BlockInbox." },
        { quoted: m }
      );
    }
  }
};